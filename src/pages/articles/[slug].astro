---
import Layout from '../../layouts/Layout.astro';
import NewsletterSignup from '../../components/NewsletterSignup.astro';

const allArticles = await Astro.glob('../../articles/*.md');

export async function getStaticPaths() {
  const articles = await Astro.glob('../../articles/*.md');
  return articles.map(article => ({
    params: { slug: article.file.split('/').pop().replace('.md', '') },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content, frontmatter } = article;
const slug = Astro.params.slug;

// Find related articles by shared tags
const currentTags = frontmatter.tags || [];
const relatedArticles = allArticles
  .filter(a => {
    const aSlug = a.file.split('/').pop().replace('.md', '');
    return aSlug !== slug;
  })
  .map(a => {
    const aTags = a.frontmatter.tags || [];
    const sharedTags = currentTags.filter(tag => aTags.includes(tag));
    return {
      slug: a.file.split('/').pop().replace('.md', ''),
      title: a.frontmatter.title,
      excerpt: a.frontmatter.excerpt,
      date: a.frontmatter.date,
      sharedCount: sharedTags.length,
    };
  })
  .filter(a => a.sharedCount > 0)
  .sort((a, b) => b.sharedCount - a.sharedCount || new Date(b.date).getTime() - new Date(a.date).getTime())
  .slice(0, 3);

// Use SEO-specific frontmatter if available, fallback to defaults
const pageTitle = frontmatter.seo_title || frontmatter.title;
const pageDescription = frontmatter.meta_description || frontmatter.excerpt;

// Article structured data for SEO
const graphItems = [
  {
    "@type": "Article",
    "headline": frontmatter.title,
    "description": pageDescription,
    "datePublished": frontmatter.date,
    "dateModified": frontmatter.date,
    "author": {
      "@type": "Person",
      "name": "Collin Wilkins",
      "url": "https://collinwilkins.com/about"
    },
    "publisher": {
      "@type": "Person",
      "name": "Collin Wilkins"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://collinwilkins.com/articles/${slug}`
    }
  },
  {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://collinwilkins.com"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Articles",
        "item": "https://collinwilkins.com/articles"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": frontmatter.title
      }
    ]
  }
];

// Add FAQPage schema if article has FAQs defined in frontmatter
if (frontmatter.faqs && frontmatter.faqs.length > 0) {
  graphItems.push({
    "@type": "FAQPage",
    "mainEntity": frontmatter.faqs.map(faq => ({
      "@type": "Question",
      "name": faq.q,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": faq.a
      }
    }))
  });
}

const articleSchema = {
  "@context": "https://schema.org",
  "@graph": graphItems
};
---

<Layout
  title={`${pageTitle} | Collin Wilkins`}
  description={pageDescription}
  type="article"
  publishedTime={frontmatter.date}
  schema={articleSchema}
>
  <div class="container mx-auto px-4 py-16">
    <div class="max-w-3xl mx-auto">
      <a href="/" class="text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] mb-8 inline-block">
        ‚Üê Back to Articles
      </a>
      <h1 class="text-3xl font-serif font-bold text-[var(--color-text-primary)] mb-4">{frontmatter.title}</h1>
      <article class="text-moonlight-text-secondary mb-4">
        {new Date(frontmatter.date).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}
      </article>
      <div class="flex flex-wrap gap-2 mb-8">
        {frontmatter.tags?.map(tag => (
          <span class="bg-[var(--color-surface)] text-[var(--color-text-secondary)] text-sm px-3 py-1 rounded-full border border-[var(--color-border)]">
            {tag}
          </span>
        ))}
      </div>
      
      <div class="prose prose-invert max-w-none prose-headings:font-serif prose-headings:text-[var(--color-text-primary)] prose-p:text-moonlight-text-secondary prose-a:text-[var(--color-accent)] prose-strong:text-[var(--color-text-primary)] prose-code:text-[var(--color-text-secondary)] prose-pre:bg-[var(--color-surface)] prose-pre:border prose-pre:border-[var(--color-border)]">
        <Content />
      </div>

      {/* Newsletter Signup */}
      <NewsletterSignup variant="inline" />

      {/* Related Articles */}
      {relatedArticles.length > 0 && (
        <div class="mt-16 border-t border-[var(--color-border)] pt-12">
          <h2 class="text-2xl font-serif font-bold text-[var(--color-text-primary)] mb-8">Related Articles</h2>
          <div class="grid gap-6 md:grid-cols-3">
            {relatedArticles.map(related => (
              <a
                href={`/articles/${related.slug}`}
                class="bg-[var(--color-surface)] rounded-xl p-6 hover:bg-[var(--color-surface-hover)] transition duration-300 border border-[var(--color-border)] hover:border-[var(--color-border-hover)] group"
              >
                <h3 class="text-lg font-serif font-bold text-[var(--color-text-primary)] mb-2 group-hover:text-[var(--color-text-primary)] transition leading-tight">
                  {related.title}
                </h3>
                <p class="text-moonlight-text-muted text-sm mb-3">
                  {new Date(related.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}
                </p>
                <p class="text-moonlight-text-secondary text-sm line-clamp-2">{related.excerpt}</p>
              </a>
            ))}
          </div>
        </div>
      )}

      {/* Article Footer CTA */}
      <div class="mt-20 p-8 md:p-12 bg-[var(--color-surface)] rounded-2xl border border-[var(--color-border)] shadow-2xl relative overflow-hidden group">
        <div class="absolute top-0 right-0 w-32 h-32 bg-[var(--color-blur-primary)] rounded-full -mr-16 -mt-16 blur-2xl transition-colors duration-500"></div>
        <div class="relative z-10">
          <h3 class="text-2xl font-serif font-bold text-[var(--color-text-primary)] mb-4">Wrestling with a technical challenge?</h3>
          <p class="text-xl text-moonlight-text-secondary mb-8 max-w-2xl leading-relaxed">
            I help companies automate complex workflows, integrate AI into their stacks, and build scalable cloud architectures.
          </p>
          <div class="flex flex-col sm:flex-row gap-4">
            <a
              href="/quiz"
              class="inline-flex items-center justify-center bg-[var(--color-accent)] text-white hover:bg-[var(--color-accent-hover)] font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105 shadow-xl"
            >
              Get Your AI Plan
            </a>
            <a
              href="/services"
              class="inline-flex items-center justify-center bg-[var(--color-surface)] text-[var(--color-text-primary)] border border-[var(--color-border)] hover:bg-[var(--color-surface-hover)] hover:border-[var(--color-border-hover)] font-bold py-3 px-8 rounded-full transition-all duration-300"
            >
              View My Services
            </a>
            <a
              href="https://www.linkedin.com/in/collin-wilkins-1020215a/"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center bg-[var(--color-surface)] hover:bg-[var(--color-surface-hover)] text-[var(--color-text-primary)] font-bold py-3 px-8 rounded-full transition-all duration-300 border border-[var(--color-border)] hover:border-[var(--color-border-hover)]"
            >
              Connect on LinkedIn
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
